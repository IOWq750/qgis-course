# (PART) Растровый анализ {-}

# Оптимизация местоположения {#weighted-overlay}


## Введение {#weighted-overlay-intro}

**Цель задания** — овладеть основами растрового анализа в ГИС на примере решения задачи поиска оптимального местоположения для размещения объектов.

**Необходимая теоретическая подготовка:** Растровая модель пространственных данных, вычисление евклидова расстояния на плоскости, методы классификации числовых рядов, оверлей с весовыми коэффициентами (взвешенный оверлей).

**Необходимая практическая подготовка:** Знание основных компонент интерфейса QGIS (менеджер источников данных, таблица слоёв, фрейм карты, менеджер компоновок). Работа с различными форматами источников пространственных данных . Настройка символики и подписей объектов. Владение базовыми ГИС-технологиями.

**Исходные данные:** База данных ГИС «Сатино», цифровая модель рельефа Сатинского полигона

**Результат:** Набор пространственных данных, содержащий участок, оптимальный по совокупности критериев для размещения объектов.

### Контрольный лист {#weighted-overlay-control}

* Конвертировать слой землепользования в растровое представление
* Построить и классифицировать растр углов наклона рельефа
* Построить и классифицировать растры расстояний до водотоков и домов
* Осуществить взвешенный оверлей полученных растров
* Конвертировать класс с максимальной суммой баллов в векторное представление и выбрать участок, удовлетворяющий критерию минимальной площади.


### Аннотация {#weighted-overlay-annotation}

В предыдущих заданиях вы познакомились с редактированием векторных данных. Для ряда практических задач более удобным оказывается растровое представление. Оно хорошо подходит для анализа географического пространства, которое обладает постоянно меняющимися характеристиками среды. Растровая модель топологически неразрывна, что позволяет моделировать различные поля и перенос вещества в пространстве из одной ячейки в другую. В силу своей регулярности растровая модель проста в обработке, поскольку все операции можно унифицировать, ориентируясь на матрицу ячеек. В частности, к растровым слоям удобно применять операции алгебры карт, такие как сложение, вычитание, суммирование — что и используется данном задании.

Вам предстоит решить задачу выбора оптимального местоположения участка для строительства производственного объекта. Критерии выбора следующие:

* предельный угол наклона рельефа — *12,5°*;

* участок должен располагаться вблизи автомобильных дорог;

* участок должен располагаться вблизи крупных водотоков, поскольку требуется водоснабжение;

* оптимальные зоны для размещения — открытые пространства, такие как выгоны, пустыри, луга, вырубки и т.д;

* необходимая площадь участка — не менее *30 000 м^2^*.


### Добавление исходных данных {#weighted-overlay-init}
[В начало упражнения ⇡](#weighted-overlay)

1. Скопируйте папку с исходными данными в вашу рабочую директорию и создайте в ней новый проект QGIS.

2. Создайте в этой же папке вложенную папку `processing`. Вы будете использовать её для хранения промежуточных результатов.

2. Добавьте в проект цифровую модель рельефа (ЦРМ, файл `DEM.tif`).

    ![](images/Ex12/dem.png)
    
3. Откройте свойства слоя ЦМР и перейдите на вкладку «Информация». Изучите характеристики файла ЦМР.

> Для описания геометрии растрового набора данных обязательно задаются следующие характеристики: число строк, число столбцов, шаг сетки (размер ячейки), начальные координаты. Некоторые форматы хранения растровых данных (в том числе GeoTIFF) поддерживают многоканальность; в этом случае указывается также число каналов. Наконец, некоторые  В разном программном обеспечении эти параметры могут называться немного по-разному.

**Вопрос 1**: впишите в отчётный файл основные характеристики ЦМР.
    
## Расчет углов наклона {#weighted-overlay-slopes}
[В начало упражнения ⇡](#weighted-overlay)

В QGIS имеется ряд инструментов для создания и анализа поверхностей, представленных в растровой форме. Изучите список доступных инструментов в меню «Растр» — «Анализ». 

> Создание, анализ и визуализация поверхностей (в том числе поверхности рельефа) — большая область исследований на стыке геоинформатики, физической географии и ряда других наук. В зарубежной традиции её принято называть геоморфометрией (англ. *geomorphometry*). Создание и использование алгоритмов расчёта морфометрических характеристик поверхности, таких как крутизна и экспозиция склона — одна из многих задач, решаемых геоморфометрией.

3. Откройте интерфейс инструмента «Крутизна...» из группы «Растр» — «Анализ».

4. Задайте DEM в качестве исходного слоя, все остальные параметры сохраните по умолчанию. Сверните блок «Дополнительные параметры» — в этом упражнении они не требуются.

5. Укажите путь к выходному файлу. По умолчанию QGIS предлагает вам сохранять результат во временный файл, но мы запишем результат явно. Для этого нажмите на многоточие `...` справа от поля «Крутизна» в нижней части формы и выберите опцию «Сохранить в файл». Укажите, что файл следует сохранить в папку `processing` под именем `slope.tif`.  
    
    В итоге интерфейс настройки инструмента «Крутизна...» будет выглядеть, как показано на рисунке ниже:
    
    ![](images/Ex12/slope_settings.png)
    
6. Убедитесь, что опция «Открыть выходной файл после исполнения алгоритма» включена. ЦЗапустите инструмент. Дождитесь, пока результат расчёта добавится в проект. Присвойте добавленному слою имя «Крутизна», слой цифровой модели рельефа отключите.

**Скриншот 1:** рассчитанный растр крутизны склона

7. Изучите свойства рассчитанного набора данных.

    Обратите внимание, что геометрия полученного растра (число строк и столбцов, размер ячейки) полностью совпадает с геометрией исходной ЦМР. 
    
    > Для любознательных: если вы увеличите изображение до края полученного растра и одновременно включите обратно слой ЦМР, вам может показаться, что растр ЦМР «шире», чем растр крутизны. Это на самом деле не так: просто краевым ячейкам растра крутизны присвоены значения «нет данных». При желании можно этого избежать, включив опцию «Обрабатывать краевые ячейки» в настройках инструмента расчёта крутизны.
    
    Далее мы получим ещё несколько растровых наборов данных, но уже не на основе ЦМР. Однако нам придётся следить, чтобы все растры имели одинаковую геометрию. В некоторых программных продуктах (GRASS, SAGA) это требование соблюдается автоматически, в других (ArcGIS) можно заранее задать необходимые настройки. QGIS в настоящее время не поддерживает такие опции на уровне проекта, поэтому геометрию растра придётся задавать каждый раз отдельно.
    
8. Закройте свойства слоя «Крутизна».


## Расчет расстояний {#weighted-overlay-distances}
[В начало упражнения ⇡](#weighted-overlay)

### Дороги {#weighted-overlay-roads}

Чтобы определить участки, наиболее подходящие с точки зрения транспортной доступности, можно построить растр, в каждой ячейке которого будет содержится расстояние (евклидово) от центра этой ячейки до ближайшей дороги. Такое представление имитирует непрерывное поле расстояний. 

1. Добавьте на карту слой дорог `Roads` из базы геоданных `Satino`.

2. Изучите таблицу атрибутов слоя.

    **Вопрос 2**: как соотносятся записи в поле `Type` и поле `Description`? Какие значения поля `Type` имеют асфальтированные и просёлочные дороги?

    Для того, чтобы построить растр расстояний, мы сначала конвертируем данные о дорогах в растровое представление

3. Конвертируйте слой дорог в растр. Для этого запустите инструмент «Растр» — «Преобразование» — «Растеризация (вектор в растр)...». Настройте параметры инструмента, как описано ниже:

    a. Исходный набор данных: `Roads`;
  
    b. Поле, содержащее значение для затемнения: `Type`. Название опции переведено некорректно — на самом деле здесь задаётся столбец таблицы атрибутов, значения из которого будут записаны в результирующий растр. Большинство растровых форматов не поддерживают запись строковых переменных в ячейки растра, поэтому система позволяет использовать только атрибуты «числовых» типов. 
  
    c. Единицы измерения выходного растра: единицы, используемые при геопривязке;
  
    d. Ширина/горизонтальное разрешение: 5;
  
    e. Высота/вертикальное разрешение: 5;
  
    f. Целевой охват: нажмите на многоточие справа, выберите опцию «Использовать охват слоя...» и используйте охват слоя DEM;
  
    g. Целевой растр: сохраните растр под названием `roads.tif` в папку `processing`;  
    
    Интерфейс настройки инструмента примет вид, как показано на рисунке ниже

    ![](images/Ex12/distance_settings.png)
    
    ***Важное замечание**: настройки c — f в списке выше отвечают за геометрию растра. Мы задали их таким образом, чтобы конфигурация создаваемого растра соответствовала тем растрам, которые уже есть в проекте.* 

4. Рассчитайте евклидово расстояние до дорог. Для этого запустите инструмент «Растр» —  «Анализ» — «Близость (расстояния в растре)...».

5. Настройте инструмент следующим образом:

    * Исходный слой: растровый слой дорог;
    
    * Список значений пикселов в исходном изображении...: перечислите через запятую те значения, которые соответствуют асфальтированным и просёлочным дорогам.
    
    * Единицы расстояния: координаты геопривязки  
    
    Остальные параметры оставьте по умолчанию. Сохраните результат в папку `processing` под именем `distance_to_roads.tif`. Убедитесь, что включена настройка добавления результата в проект после окончания расчёта.
    
6. Когда слой добавится в проект, переименуйте его в «Расстояние до дорог».

7. Измените символику слоя:

    * Стиль: одноканальное псевдоцветное» 
    * Минимальное значение: 0
    * Максимальное значение: 2500
    * Тип интерполяции: дискретная 
    * Градиент: Magma (после установки градиента нажмите на него правой кнопкой мыши и используйте опцию «Инвертировать градиент»)
    * Мода: «равные интервалы»
    * Число классов: 25
    
    В некоторых версиях QGIS может потребоваться нажать кнопку «Классифицировать», чтобы применить заданные настройки. Итоговый результат должен выглядеть как послойная окраска изолиний. В случае затруднений с настройкой символики обратитесь к преподавателю.
    
8. Разместите растровый слой дорог над слоем расстояний до дорог. Сделайте скриншот окна QGIS.

**Скриншот 2:** рассчитанный растр расстояний до дорог

### Водотоки {#weighted-overlay-streams}

1. Отключите все слои.

1. Добавьте на карту слой «площадных» объектов гидрографии `WaterPolygon` из базы геоданных `Satino`.

2. Выберите (любым способом) объекты, соответствующие р. Протве и р. Исьме.

3. Растеризуйте выбранные объекты. Самостоятельно установите настройки инструмента растеризации таким образом, чтобы использовать только выделенные объекты. Ячейкам растра, соответствующим объектам гидрографии, должно быть присвоено фиксированное значение 1 (атрибутивные поля не используются). Кроме того, геометрия получаемого растра должна быть аналогична всем остальным растрам в проекте. Сохраните растр в папку `processing` под именем `water.tif`.

    *Примечание: в некоторых версиях QGIS после активации опции «Только выделенные объекты» выдаётся сообщение об ошибке, как на рисунке ниже. **Сообщение об ошибке можно игнорировать.***
    
    ![](images/Ex12/rasterize_problem.png)

4. Рассчитайте евклидово расстояние до водотоков аналогично тому, как вы рассчитывали евклидово расстояние до дорог. Назовите выходной файл `distance_to_water.tif`.

5. Когда новый слой добавится в проект, переименуйте его в «Расстояние до водотоков».

6. Скопируйте символику из слоя «Расстояние до дорог» (контекстное меню слоя — «Стили» — «Копировать стиль») в слой «Расстояние до водотоков» (контекстное меню слоя — «Стили» — «Вставить стиль»).

Расположите векторный слой объектов гидрографии над растром расстояния до водотоков и отключите все остальные слои. Сделайте скриншот окна QGIS

**Скриншот 3:** рассчитанный растр расстояний до водотоков

## Переклассификация наборов данных {#weighted-overlay-reclass}
[В начало упражнения ⇡](#weighted-overlay)

Мы подготовили три набора данных, характеризующих различные критерии пригодности участков для строительства. Два их них измеряются в метрах, ещё один — в градусах. Для того, чтобы иметь возможность сопоставлять величины, измеренные в разных единицах, можно использовать нормирование или перейти от точных значений к баллам благоприятности. В последнем случае говорят о **переклассификации** числового ряда. Мы определим балльную оценку на основе имеющихся значений растров.

В большинстве программных средств ГИС существуют специальные инструменты для переклассификации значении растров. Они называются Reclass, Reclassify или другим аналогичным образом. QGIS — исключение. Штатный способ сделать переклассификацию в QGIS предполагает использование *Калькулятора растров*. Это инструмент, который позволяет применять алгебраические выражения к значениям исходных растров и получать производные растры с рассчитанными значениями.

### Переклассификация растра крутизны {#weighted-overlay-reclass-slope}





## Преобразование слоя типов землепользования в растровое представление {#weighted-overlay-rasterize}
[В начало упражнения ⇡](#weighted-overlay)


### Добавление исходных данных {#weighted-overlay-init1}

Скопируйте папку с исходными данными в вашу рабочую директорию и создайте в ней новый проект QGIS.

Добавьте в проект следующие наборы данных:

* Цифровую модель рельефа (`DEM.tif`);

* Набор данных о дорожной сети (`LandUse`) из базы данных `Satino.gdb`.

* Набор полигональных данных об объектах гидрографии (`LandUse`) из базы данных `Satino.gdb`.

* Набор данных о землепользовании (`LandUse`) из базы данных `Satino.gdb`.
