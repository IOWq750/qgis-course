# Привязка и цифрование административной карты {#map-ref-economic}

## Введение {#map-ref-economic-intro}

**Цель задания** — знакомство с привязкой, трансформированием и цифрованием геоизображений, элементами базовых технологий ГИС (оверлей, пространственные запросы).

**Необходимая теоретическая подготовка:** Системы координат и проекции карт, привязка геоизображений, трансформирование геоизображений, цифрование геоизображений. Методы трансформации: аффинное, проективное, полиномиальное, метод резинового листа (сплайны). Пространственные запросы, атрибутивные запросы, оверлей.

**Необходимая практическая подготовка:** Знание основных компонент интерфейса QGIS (менеджер источников данных, панель слоёв, фрейм карты, окно настройки компоновки). Добавление источников пространственных данных в проект. Настройка символики и подписей объектов. Создание макета, добавление карты и зарамочного оформления, экспорт макета.

**Исходные данные:** Cлои картографической основы OpenStreetMap, растровая карта избирательных округов г. Белгорода.

**Результат:** Набор пространственных данных с избирательными округами г. Белгорода и статистикой по застройке в пределах округов. Картодиаграммы по количеству домов и степени застроенности. Картографическое изображение.

### Контрольный лист {#map-ref-economic-control}

* Привязать растровую карту к опорным данным
* Создать класс избирательных округов путем цифрования растровой карты
* Добавить номера районов в таблицу атрибутов
* Определить (путем применения серии пространственных запросов) структуру застройки в каждом округе
* Построить картодиаграммы по полученным значениям
* Подготовить проект карты с компоновкой

## Добавление базовых данных {#map-ref-economic-basemap}
[В начало упражнения ⇡](#map-ref-economic)

1. Скачайте архив и распакуйте его в свою рабочую директорию. 

2. Создайте проект QGIS и сохраните его в распакованную папку (*Ex05_RefAdm*) в своей рабочей директории.

3. В менеджере источников данных найдите расположение проекта и разверните содержимое базы `belgorod.gpkg`.

    ![](images/Ex05/GeoPackage_structure.png)
    
    >Формат [GeoPackage](http://www.geopackage.org/) был предложен в середине 2010-х как открытая [альтернатива существующим форматам](https://imgs.xkcd.com/comics/standards.png) хранения пространственных данных: [шейп-файлу](http://switchfromshapefile.org/#shapefileisbad) и базам геоданных ESRI. GeoPackage представляет собой базу данных SQLite, внутри которой содержатся таблицы с данными и таблицы с метаданными. Такой подход аналогичен базе геоданных ESRI. Однако, в отличие от базы геоданных и от шейп-файлов, GeoPackage хранит всю необходимую информацию в одном файле (*.gpkg). Это позиционируется как одно из главных преимуществ формата.

4. Добавьте все наборы из базы `belgorod.gpkg` на карту.

    >*Примечание: проще всего сделать это через менеджер источников данных. Другой вариант — перетащить файл из окна системного файлового менеджера.* 
    
5. Разместите слои в следующем порядке и настройте их символику:

    - **железные дороги:** тёмно-серые линии толщиной 0,4 мм;
    - **автодороги:** светло-оранжевые линии толщиной 0,26 мм;
    - **здания и сооружения:** заливка светло-серого цвета без обводки;
    - **водоёмы:** используйте стиль `topo water`;
    - **водотоки:** синие линии толщиной 0,26 мм;
    - **административные границы:** иcпользуйте стиль `outline red`.
    
    Задайте слоям русскоязычные названия

6. Отобразите карту в охвате слоя границ.

    **Скриншот 1:** окно QGIS после завершения настройки символики
    
    **Вопрос 1:** какая система координат используется в проекте? Для чего обычно применяется эта система координат?
    
## Привязка карты {#map-ref-economic-referencing}
[В начало упражнения ⇡](#map-ref-economic)

1. Для привязки растров в QGIS имеется модуль «Привязка растров (GDAL)». Чтобы запустить его, выберите «Растр» — «Привязка растров...». Откроется окно модуля привязки.

    >Примечание: Если в меню «Растр» нет нужного пункта, следует зайти в меню «Модули» — «Управление модулями...» и в разделе «Установленные» включить модуль «Привязка растров (GDAL)». «Привязка растров» — модуль, который входит в ядро QGIS, он обязательно устанавливается вместе с основной программой.
    
2. В окне привязки нажмите кнопку «Открыть растр» и откройте файл `ElectionMap.jpg`, который находится в вашей рабочей директории. При загрузке QGIS попросит вас указать систему координат для добавляемого растра. Выбирайте ту же систему координат, которая используется в проекте.

3. Расположите окно модуля привязки таким образом, чтобы оно не закрывало основной фрейм карты. Выключите панели инструментов QGIS, если они вам мешают.

    ![](images/Ex05/Reference1.png)
    
    Обратите внимание, что растровое изображение выглядит искажённым («сплюснутым») по сравнению с изображением в основном окне QGIS. Если вы откроете растр в какой-либо программе просмотра изображений, вы убедитесь, что растр действительно будто бы «сжат» по вертикали.
    
4. Перемещаясь по карте, найдите соответствующие точки на изображении и в основном окне QGIS

   ![](images/Ex05/Reference2.png)
   
5. Используя инструмент «Добавить точку» в окне модуля привязки, установите первую точку на растровом изображении (щелчком левой кнопки мыши). QGIS выдаст запрос на ввод координат:

    ![](images/Ex05/Reference3.png)
    
6. В некоторых случаях можно ввести координаты вручную, но нам будет проще «снять их с карты», то есть указать соответственную точку в основном окне QGIS. Нажмите кнопку «С карты». Окна модуля привязки при этом свернутся.

7. Щёлкните левой кнопкой мыше в соответствующей точке основного окна QGIS. Программа автоматически считает координаты точки и подставит их в форму:

    ![](images/Ex05/Reference4.png)
    
8. Нажмите OK, чтобы добавить первую опорную точку.

    >Примечание: счёт опорных точек в QGIS начинается с нуля, поэтому первая точка получит индекс «0», вторая — «1» и так далее.
    
9. **Найдите и расставьте ещё 7-8 опорных точек.**. Точки должны быть равномерно распределены по полю карты и не находиться на одной линии. В качестве опорных точек лучше всего использовать пересечения автодорог и/или железных дорог. Кроме того, не следует использовать контура границ для расстановки опорных точек — в представленных материалах они не совпадают!

10. Откройте окно параметров трансформации ![](images/Ex05/parameters.png) и ознакомьтесь с доступными параметрами трансформации.

    **Вопрос 2:** какие типы трансформации растра доступны в QGIS? В каких случаях они применяются? Сколько точек необходимо для осуществления каждого типа трансформации? 
    

11. Настройте параметры трансформации следующим образом:

    - **Тип трансформации:** Проективная;
    - **Метод интерполяции:** Ближайший сосед;
    - **Целевая система координат:** такая же, как СК проекта;
    - Остальные параметры оставьте по умолчанию
    - Обязательно включите опцию «Открыть результат в QGIS»
    
12. Нажмите ОК, чтобы закрыть окно параметров трансформации и сохранить изменения настроек.

13. Изучите таблицу опорных точек, которая отображается внизу окна модуля привязки. Если суммарная невязка для какой-либо точки превышает 0,5 пикселя, отключите её и добавьте новую точку. Не удаляйте отключённые точки!

    >Подсказка: чтобы легче было ориентироваться в опорных точках, можно включить отображение идентификаторов точек в настройках модуля привязки.

    **Вопрос 3:** Можно ли загружать и сохранять опорные точки привязки в QGIS? Если да, как это сделать?

14. Когда точность всех активных опорных точек составит меньше 1 пикселя, нажмите кнопку![](images/Ex05/go.png), чтобы запустить процесс привязки. В результате будет создан новый файл, который автоматически добавится в основное окно QGIS.

15. Изучите результат привязки. Если он устраивает вас, окно привязки можно закрывать. Если нет, удалите добавленный слой, вернитесь в окно привязки, внесите необходимые изменения и запустите привязку ещё раз.

    **Скриншот 2:** окно QGIS после завершения привязки.
    
## Создание слоя избирательных округов {#map-ref-districts-creation}
[В начало упражнения ⇡](#map-ref-economic)

1. Отключите все слои, кроме административных границ. Разместите привязанный растр в таблице слоёв под слоем административных границ.

